---
layout:     post

title:      FFMPEG ç¼–ç æ€»ç»“

date:       2024-12-04

author:     phoenixZ

header-img: img/oip2.jpg

catalog: true

tags:

    - FFMPEG
---
# ğŸš€ åˆå§‹åŒ–è¿‡ç¨‹

## åˆå§‹åŒ–FFmpegç½‘ç»œåº“

```cpp
avformat_network_init();
```

## åˆ›å»ºè¾“å‡ºæ ¼å¼ä¸Šä¸‹æ–‡

> æŒ‡å®šrtspåè®®ä½œä¸ºè¾“å‡ºæ ¼å¼

```cpp
AVFormatContext *format_context = nullptr;

const char *rtsp_url = "rtsp://your-server-ip:port/stream";

if (avformat_alloc_output_context2(&format_context, nullptr, "rtsp", rtsp_url) < 0) {
    fprintf(stderr, "Could not create output context\n");
    return -1;
}
```

## æŸ¥æ‰¾ç¼–ç å™¨

> æ ¹æ®ç±»å‹æŒ‡å®šç¼–ç å™¨ï¼š`constAVCodec*codec=avcodec_find_encoder_by_name("h264_nvenc");`

```cpp
AVCodec *codec = avcodec_find_encoder(AV_CODEC_ID_H264);

if (!codec) {
    fprintf(stderr, "Codec not found\n");
    return -1;
}
```

## åˆ›å»ºè§†é¢‘æµ

> ä¸ºæ¯ä¸ªæµé…ç½®ç¼–ç å™¨ä¸Šä¸‹æ–‡
>
> è®¾ç½®ç¼–ç å™¨è¾“å‡ºæ ¼å¼

```cpp
AVStream *video_stream = avformat_new_stream(format_context, codec);
if (!video_stream) {
    fprintf(stderr, "Could not create new video stream\n");
    return -1;
}AVCodecContext *codec_context = avcodec_alloc_context3(codec);
if (!codec_context) {
    fprintf(stderr, "Could not allocate codec context\n");
    return -1;
}codec_context->bit_rate = 400000;
codec_context->width = 1920;
codec_context->height = 1080;
codec_context->time_base = (AVRational){1, 25};
codec_context->framerate = (AVRational){25, 1};
codec_context->pix_fmt = AV_PIX_FMT_YUV420P;
```

## æ‰“å¼€ç¼–ç å™¨

```cpp
if (avcodec_open2(codec_context, codec, nullptr) < 0) {
    fprintf(stderr, "Could not open codec\n");
    return -1;
}
```

# ğŸš€ ç¼–ç æ¨æµ

## åˆ†é…å¹¶åˆå§‹åŒ–AVFrame

> AVFrame å­˜å‚¨å¾…ç¼–ç çš„å›¾åƒæ•°æ®
>
> éœ€è¦ä¸ºå›¾åƒå¸§åˆ†é…ç¼“å†²åŒº
>
> æ ¹æ®ç¼–ç å™¨ä¸Šä¸‹æ–‡é…ç½®æ ¼å¼ã€åˆ†è¾¨ç‡

```cpp
AVFrame *frame = av_frame_alloc();
if (!frame) {
    fprintf(stderr, "Could not allocate frame\n");
    return -1;
}frame->format = codec_context->pix_fmt;
frame->width  = codec_context->width;
frame->height = codec_context->height;int ret = av_frame_get_buffer(frame, 32);
if (ret < 0) {
    fprintf(stderr, "Could not allocate frame buffer\n");
    return -1;
}
```

## å†™å…¥rtspå¤´ä¿¡æ¯

```cpp
if (avformat_write_header(format_context, nullptr) < 0) {
    fprintf(stderr, "Error writing header\n");
    return -1;
}
```

## ç¼–ç å¸§æ•°æ®å¹¶å‘é€

> avcodec_send_frame : å°†å¸§æ•°æ®é€åˆ°ç¼–ç å™¨, è¿”å›AVPacket
>
> av_interleaved_write_frame: å°†ç¼–ç åçš„æ•°æ®é€åˆ°RTSPæœåŠ¡å™¨

```cpp
AVPacket packet;
ret = avcodec_send_frame(codec_context, frame);
if (ret < 0) {
    fprintf(stderr, "Error sending frame to encoder: %s\n", av_err2str(ret));
    return -1;
}// è·å–ç¼–ç åçš„æ•°æ®åŒ…
ret = avcodec_receive_packet(codec_context, &packet);
if (ret == 0) {
    // å°†æ•°æ®åŒ…æ¨é€åˆ° RTSP æœåŠ¡å™¨
    ret = av_interleaved_write_frame(format_context, &packet);
    if (ret < 0) {
        fprintf(stderr, "Error writing packet to RTSP stream: %s\n", av_err2str(ret));
        return -1;
    }
    av_packet_unref(&packet);
} else if (ret == AVERROR(EAGAIN)) {
    fprintf(stderr, "Encoder did not return a packet yet\n");
} else if (ret == AVERROR_EOF) {
    fprintf(stderr, "Encoder reached end of input\n");
} else {
    fprintf(stderr, "Error receiving packet from encoder: %s\n", av_err2str(ret));
}
```

# ğŸ¯ å‚è€ƒ

[ç¼–è§£ç æ¨æµ](https://github.com/PhoenixZqh/ffmpeg_explore)
