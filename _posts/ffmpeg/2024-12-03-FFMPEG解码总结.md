---
layout:     post

title:      FFMPEG è§£ç æ€»ç»“

date:       2024-12-03

author:     phoenixZ

header-img: img/oip2.jpg

catalog: true

tags:

    - FFMPEG
---
# ğŸš€ åˆå§‹åŒ–

* åˆå§‹åŒ–ç¼–è§£ç å™¨

```cpp
avcodec_register_all();
```

* åˆå§‹åŒ–ç½‘ç»œåè®®

```cpp
avformat_network_init();
```

* æ‰“å¼€æ–‡ä»¶æˆ–æµ

```cpp
avformat_open_input(&pFormatCtx, rtspUrl.c_str(), nullptr, nullptr)
```

â˜ï¸ è¿™é‡Œçš„ç¤ºä¾‹æ˜¯rtspæµï¼ŒåŒæ ·ä¹Ÿå¯ä»¥è§£ç æ–‡ä»¶

* æŸ¥æ‰¾æµä¿¡æ¯

```cpp
if (avformat_find_stream_info(pFormatCtx, nullptr) <0)
```

* æŸ¥æ‰¾è§£ç å™¨

```cpp
AVCodec*pCodec=avcodec_find_decoder_by_name("h264");
```

* ä¸ºè§£ç å™¨åˆ†é…ä¸Šä¸‹æ–‡

```
pCodecCtx=avcodec_alloc_context3(pCodec);
```

â˜ï¸ åˆ†é…AVCodecContextç»“æ„ä½“(å­˜å‚¨è§£ç å™¨ç›¸å…³çŠ¶æ€å’Œé…ç½®çš„æ ¸å¿ƒæ•°æ®ç»“æ„)

* å¡«å……è§£ç å™¨ä¸Šä¸‹æ–‡ (åŒ…æ‹¬åƒç´ æ ¼å¼ã€å®½åº¦ã€é«˜åº¦ç­‰ä¿¡æ¯)

```cpp
avcodec_parameters_to_context(pCodecCtx, pFormatCtx->streams[videoStreamIndex]->codecpar);
```

* å°†AVCodecContext ä¸æŒ‡å®šçš„ AVCodec ç¼–è§£ç å™¨å…³è”ï¼Œä¿è¯ç¼–/è§£ç å™¨èƒ½è¿›è¡Œå®é™…çš„æ•°æ®å¤„ç†

```cpp
avcodec_open2(pCodecCtx, pCodec, nullptr)
```

# ğŸš€ è§£ç 

* ä»ä¸Šä¸‹æ–‡ä¸­æ‰“å¼€åª’ä½“æ–‡ä»¶ï¼Œå­˜å‚¨åœ¨pktä¸­

```cpp
av_read_frame(pFormatCtx, &pkt)
```

* è§£ç å™¨è¿›è¡Œè§£ç 

```cpp
avcodec_send_packet(pCodecCtx, &pkt)
```

* æ¥æ”¶å·²ç»è§£ç çš„æ•°æ®

```cpp
avcodec_receive_frame(pCodecCtx, pFrameYUV)
```

# ğŸš€ å¸¸è§ç»“æ„ä½“è¯´æ˜

## AVFormatContext

> è§£å°è£…ä¸Šä¸‹æ–‡ï¼Œæ˜¯å­˜å‚¨éŸ³è§†é¢‘å°è£…æ ¼å¼ä¸­åŒ…å«ä¿¡æ¯çš„ç»“æ„ä½“

```xml
char filename[1024] // ä¿å­˜æ‰“å¼€çš„æ–‡ä»¶åï¼Œä¸€èˆ¬ç”¨åœ¨ rtspã€rtmp æ–­å¼€é‡è¿
unsignedint nb_streams // éŸ³è§†é¢‘æµçš„ä¸ªæ•°
AVStream **streams // å­˜å‚¨è§†é¢‘æµã€éŸ³é¢‘æµã€å­—å¹•æµä¿¡æ¯
int64_t duration // åª’ä½“æ–‡ä»¶çš„æ€»æ—¶é•¿ï¼Œå•ä½æ˜¯æŠŠ 1 ç§’åˆ‡æˆ AV_TIME_BASEï¼ˆ1000000ï¼‰ä»½ï¼Œå³å•ä½ã€‚ä¸º usï¼Œæ³¨æ„ä¸ä¸€å®šæ¯ä¸ªè§†é¢‘éƒ½èƒ½è·å–åˆ° duration
int64_t bit_rate // æ¯”ç‰¹ç‡ï¼ˆå•ä½bpsï¼Œè½¬æ¢ä¸ºkbpséœ€è¦é™¤ä»¥1000ï¼‰
```

## AVStream

> å­˜å‚¨æ¯ä¸€ä¸ªéŸ³é¢‘/è§†é¢‘æµä¿¡æ¯çš„ç»“æ„ä½“

```xml
int index // æ ‡è¯†è¯¥è§†é¢‘/éŸ³é¢‘æµ
AVCodecContext *codec // è§£ç å™¨ï¼Œ4.0 ç‰ˆæœ¬åå·²å¼ƒç”¨
AVRational time_base // æ—¶åŸºã€‚é€šè¿‡è¯¥å€¼å¯ä»¥æŠŠPTSï¼ŒDTSè½¬åŒ–ä¸ºå®é™…çš„æ—¶é—´ï¼ˆå•ä½ä¸ºç§’sï¼‰
int64_t duration // è¯¥è§†é¢‘/éŸ³é¢‘æµæ—¶é•¿ï¼Œå•ä½ä¸º ms
AVRational avg_frame_rate // å¸§ç‡ï¼ˆæ³¨ï¼šå¯¹è§†é¢‘æ¥è¯´ï¼Œè¿™ä¸ªæŒºé‡è¦çš„ï¼‰
AVPacket attached_pic // é™„å¸¦çš„å›¾ç‰‡ã€‚æ¯”å¦‚è¯´ä¸€äº› MP3ï¼ŒAAC éŸ³é¢‘æ–‡ä»¶é™„å¸¦çš„ä¸“è¾‘å°é¢
AVCodecParameters *codecpar // éŸ³è§†é¢‘å‚æ•°ï¼Œæ–°å¢ç”¨æ¥æ›¿æ¢AVCodecContext *codec
```

## AVCodecContext

> è§£ç å™¨ä¸Šä¸‹æ–‡çš„ç»“æ„ä½“ï¼ŒåŒ…å«äº†ä¼—å¤šç¼–è§£ç å™¨éœ€è¦çš„å‚æ•°ä¿¡æ¯

```xml
enum AVMediaType codec_type // ç¼–è§£ç å™¨çš„ç±»å‹ï¼ˆè§†é¢‘ï¼ŒéŸ³é¢‘...ï¼‰
struct AVCodec  *codec // é‡‡ç”¨çš„è§£ç å™¨AVCodecï¼ˆH.264,MPEG2...ï¼‰
enum AVCodecID codec_id // æ ‡ç¤ºç‰¹å®šçš„ç¼–è§£ç å™¨ï¼ˆH.264,MPEG2...ï¼‰
int format // è§†é¢‘åƒç´ æ ¼å¼/éŸ³é¢‘é‡‡æ ·æ•°æ®æ ¼å¼
int width, height // è¡¨ç¤ºè§†é¢‘çš„å®½å’Œé«˜
int bit_rate // å¹³å‡æ¯”ç‰¹ç‡
int channels // å£°é“æ•°ï¼ˆéŸ³é¢‘ï¼‰
uint64_t channel_layout // å£°é“æ ¼å¼
int sample_rate // é‡‡æ ·ç‡ï¼ˆéŸ³é¢‘ï¼‰
AVRational time_base; // æ—¶åŸºã€‚é€šè¿‡è¯¥å€¼å¯ä»¥æŠŠPTSï¼ŒDTSè½¬åŒ–ä¸ºå®é™…çš„æ—¶é—´ï¼ˆå•ä½ä¸ºç§’sï¼‰
uint8_t *extradata; int extradata_size; // é’ˆå¯¹ç‰¹å®šç¼–ç å™¨åŒ…å«çš„é™„åŠ ä¿¡æ¯ï¼ˆä¾‹å¦‚å¯¹äºH.264è§£ç å™¨æ¥è¯´ï¼Œå­˜å‚¨SPSï¼ŒPPSç­‰ï¼‰
```

## AVCodec

> å­˜å‚¨ç¼–è§£ç å™¨ä¿¡æ¯çš„ç»“æ„ä½“

```xml
const char *name; // ç¼–è§£ç å™¨çš„åå­—çš„ç®€ç§°
const char *long_name; // ç¼–è§£ç å™¨åå­—çš„å…¨ç§°
enum AVMediaType type; // æŒ‡æ˜äº†ç±»å‹ï¼Œæ˜¯è§†é¢‘ï¼ŒéŸ³é¢‘ï¼Œè¿˜æ˜¯å­—å¹•
enum AVCodecID id; // IDï¼Œä¸é‡å¤
const AVRational *supported_framerates; // æ”¯æŒçš„å¸§ç‡ï¼ˆä»…è§†é¢‘ï¼‰
const enum AVPixelFormat *pix_fmts; // æ”¯æŒçš„åƒç´ æ ¼å¼ï¼ˆä»…è§†é¢‘ï¼‰,å¦‚RGB24ã€YUV420Pç­‰ã€‚
const int *supported_samplerates; // æ”¯æŒçš„é‡‡æ ·ç‡ï¼ˆä»…éŸ³é¢‘ï¼‰
const enum AVSampleFormat *sample_fmts; // æ”¯æŒçš„é‡‡æ ·æ ¼å¼ï¼ˆä»…éŸ³é¢‘ï¼‰
const uint64_t *channel_layouts; // æ”¯æŒçš„å£°é“æ•°ï¼ˆä»…éŸ³é¢‘ï¼‰
int priv_data_size; // ç§æœ‰æ•°æ®çš„å¤§å°
```

## AVCodecParameters

> å°†ç¼–è§£ç å™¨çš„å‚æ•°ä» AVCodecContext åˆ†ç¦»å‡ºæ¥

```
enum AVMediaType codec_type // ç¼–è§£ç å™¨çš„ç±»å‹ï¼ˆè§†é¢‘ï¼ŒéŸ³é¢‘...ï¼‰
enum AVCodecID codec_id // æ ‡ç¤ºç‰¹å®šçš„ç¼–è§£ç å™¨ï¼ˆH.264,MPEG2...ï¼‰
int format // è§†é¢‘åƒç´ æ ¼å¼/éŸ³é¢‘é‡‡æ ·æ•°æ®æ ¼å¼
int width, height // è¡¨ç¤ºè§†é¢‘çš„å®½å’Œé«˜
int bit_rate // å¹³å‡æ¯”ç‰¹ç‡
int channels // å£°é“æ•°ï¼ˆéŸ³é¢‘ï¼‰
uint64_t channel_layout // å£°é“æ ¼å¼
int sample_rate // é‡‡æ ·ç‡ï¼ˆéŸ³é¢‘ï¼‰
AVRational time_base; // æ—¶åŸºã€‚é€šè¿‡è¯¥å€¼å¯ä»¥æŠŠPTSï¼ŒDTSè½¬åŒ–ä¸ºå®é™…çš„æ—¶é—´ï¼ˆå•ä½ä¸ºç§’sï¼‰
uint8_t *extradata; int extradata_size; // é’ˆå¯¹ç‰¹å®šç¼–ç å™¨åŒ…å«çš„é™„åŠ ä¿¡æ¯ï¼ˆä¾‹å¦‚å¯¹äºH.264è§£ç å™¨æ¥è¯´ï¼Œå­˜å‚¨SPSï¼ŒPPSç­‰ï¼‰
```

## AVPacket

> ç”¨äºå­˜å‚¨å‹ç¼©éŸ³è§†é¢‘æ•°æ®çš„ç»“æ„ä½“

```xml
uint8_t data; // å‹ç¼©ç¼–ç çš„æ•°æ®ã€‚
/ ä¾‹å¦‚å¯¹äºH.264æ¥è¯´ã€‚1ä¸ªAVPacketçš„dataé€šå¸¸å¯¹åº”ä¸€ä¸ªNALã€‚
æ³¨æ„ï¼šåœ¨è¿™é‡Œåªæ˜¯å¯¹åº”ï¼Œè€Œä¸æ˜¯ä¸€æ¨¡ä¸€æ ·ã€‚ä»–ä»¬ä¹‹é—´æœ‰å¾®å°çš„å·®åˆ«ï¼šä½¿ç”¨FFMPEGç±»åº“åˆ†ç¦»å‡ºå¤šåª’ä½“æ–‡ä»¶ä¸­çš„H.264ç æµã€‚å› æ­¤åœ¨ä½¿ç”¨FFMPEGè¿›è¡ŒéŸ³è§†é¢‘å¤„ç†çš„æ—¶å€™ï¼Œå¸¸å¸¸å¯ä»¥å°†å¾—åˆ°çš„AVPacketçš„dataæ•°æ®ç›´æ¥å†™æˆæ–‡ä»¶ï¼Œä»è€Œå¾—åˆ°éŸ³è§†é¢‘çš„ç æµæ–‡ä»¶ã€‚*/
```

int size; // dataçš„å¤§å°
int64_t pts; // æ˜¾ç¤ºæ—¶é—´æˆ³
int64_t dts; // è§£ç æ—¶é—´æˆ³
int stream_index; // æ ‡è¯†è¯¥AVPacketæ‰€å±çš„è§†é¢‘/éŸ³é¢‘æµã€‚

## AVFrame

> å­˜å‚¨è§£ç åçš„è§†é¢‘å¸§æˆ–éŸ³é¢‘æ ·æœ¬çš„ç»“æ„ä½“; 
>
> è§†é¢‘æ•°æ®é€šå¸¸ä»¥ YUV æˆ– RGB æ ¼å¼å­˜å‚¨ï¼Œè€ŒéŸ³é¢‘æ•°æ®åˆ™å­˜å‚¨ä¸ºåŸå§‹ PCM æ•°æ®;

```xml
uint8_t *data[AV_NUM_DATA_POINTERS]; // è§£ç ååŸå§‹æ•°æ®ï¼ˆå¯¹è§†é¢‘æ¥è¯´æ˜¯YUVï¼ŒRGBï¼Œå¯¹éŸ³é¢‘æ¥è¯´æ˜¯PCMï¼‰
int linesize[AV_NUM_DATA_POINTERS]; // dataä¸­â€œä¸€è¡Œâ€æ•°æ®çš„å¤§å°ã€‚æ³¨æ„ï¼šæœªå¿…ç­‰äºå›¾åƒçš„å®½ï¼Œä¸€èˆ¬å¤§äºå›¾åƒçš„å®½ã€‚
int width, height; // è§†é¢‘å¸§å®½å’Œé«˜ï¼ˆ1920x1080,1280x720...ï¼‰
int nb_samples; // éŸ³é¢‘çš„ä¸€ä¸ªAVFrameä¸­å¯èƒ½åŒ…å«å¤šä¸ªéŸ³é¢‘å¸§ï¼Œåœ¨æ­¤æ ‡è®°åŒ…å«äº†å‡ ä¸ª
int format; // è§£ç ååŸå§‹æ•°æ®ç±»å‹ï¼ˆYUV420ï¼ŒYUV422ï¼ŒRGB24...ï¼‰
int key_frame; // æ˜¯å¦æ˜¯å…³é”®å¸§
enum AVPictureType pict_type; // å¸§ç±»å‹ï¼ˆI,B,P...ï¼‰
AVRational sample_aspect_ratio; // å®½é«˜æ¯”ï¼ˆ16:9ï¼Œ4:3...ï¼‰
int64_t pts; // æ˜¾ç¤ºæ—¶é—´æˆ³
int coded_picture_number; // ç¼–ç å¸§åºå·
int display_picture_number; // æ˜¾ç¤ºå¸§åºå·
```
